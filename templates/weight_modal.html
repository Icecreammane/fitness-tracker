<!-- Weight Tracking Modal -->
<div class="modal-overlay" id="weight-modal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">⚖️ Weight Check-In</div>
            <button class="modal-close" onclick="closeWeightModal()">×</button>
        </div>
        <div class="modal-body">
            <form id="weight-form" onsubmit="submitWeight(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; margin-bottom: 8px; color: #888;">Current Weight (lbs)</label>
                    <input type="number" step="0.1" id="weight-input" required
                           style="width: 100%; padding: 14px; background: #0f0f0f; border: 2px solid #2a2a2a; border-radius: 10px; color: #fff; font-size: 18px; font-weight: 600;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; margin-bottom: 8px; color: #888;">Notes (optional)</label>
                    <textarea id="weight-notes" rows="3"
                              placeholder="Feeling energized today..."
                              style="width: 100%; padding: 12px; background: #0f0f0f; border: 2px solid #2a2a2a; border-radius: 10px; color: #fff; font-size: 14px; resize: none;"></textarea>
                </div>
                
                <button type="submit" class="onboarding-btn" style="width: 100%;">
                    Save Weight
                </button>
            </form>
            
            <!-- Weight History Chart -->
            <div style="margin-top: 30px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #2a2a2a;">
                    <button class="weight-period-btn active" data-days="7" onclick="loadWeightChart(7)">7d</button>
                    <button class="weight-period-btn" data-days="30" onclick="loadWeightChart(30)">30d</button>
                    <button class="weight-period-btn" data-days="90" onclick="loadWeightChart(90)">90d</button>
                </div>
                <canvas id="weightChart" style="max-height: 250px;"></canvas>
            </div>
            
            <!-- Weight Stats -->
            <div id="weight-stats" style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <div style="background: #0f0f0f; border-radius: 10px; padding: 12px; text-align: center;">
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">CURRENT</div>
                    <div style="font-size: 20px; font-weight: 700; color: #00d4ff;" id="current-weight">--</div>
                </div>
                <div style="background: #0f0f0f; border-radius: 10px; padding: 12px; text-align: center;">
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">CHANGE</div>
                    <div style="font-size: 20px; font-weight: 700; color: #00ff88;" id="weight-change">--</div>
                </div>
                <div style="background: #0f0f0f; border-radius: 10px; padding: 12px; text-align: center;">
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">AVERAGE</div>
                    <div style="font-size: 20px; font-weight: 700; color: #888;" id="avg-weight">--</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.weight-period-btn {
    padding: 8px 16px;
    background: transparent;
    border: none;
    color: #666;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    min-height: 40px;
}

.weight-period-btn.active {
    color: #00d4ff;
    border-bottom-color: #00d4ff;
}
</style>

<script>
let weightChart = null;
let currentWeightPeriod = 7;

function openWeightModal() {
    document.getElementById('weight-modal').classList.add('active');
    loadWeightChart(currentWeightPeriod);
}

function closeWeightModal() {
    document.getElementById('weight-modal').classList.remove('active');
}

async function submitWeight(e) {
    e.preventDefault();
    
    const weight = parseFloat(document.getElementById('weight-input').value);
    const notes = document.getElementById('weight-notes').value;
    
    try {
        const res = await fetch('/api/weight', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ weight, notes })
        });
        
        const result = await res.json();
        
        if (result.success) {
            showToast('✅ Weight logged!');
            document.getElementById('weight-input').value = '';
            document.getElementById('weight-notes').value = '';
            loadWeightChart(currentWeightPeriod);
        } else {
            showToast('❌ Failed to log weight');
        }
    } catch (err) {
        showToast('❌ Error logging weight');
        console.error(err);
    }
}

async function loadWeightChart(days) {
    currentWeightPeriod = days;
    
    // Update active button
    document.querySelectorAll('.weight-period-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.days) === days);
    });
    
    try {
        const res = await fetch(`/api/weight/history?days=${days}`);
        const data = await res.json();
        
        if (!data.success) {
            showToast('❌ Failed to load weight history');
            return;
        }
        
        // Update stats
        if (data.stats.current) {
            document.getElementById('current-weight').textContent = data.stats.current + ' lbs';
            document.getElementById('weight-change').textContent = 
                (data.stats.change >= 0 ? '+' : '') + data.stats.change + ' lbs';
            document.getElementById('weight-change').style.color = 
                data.stats.change <= 0 ? '#00ff88' : '#ff4444';
            document.getElementById('avg-weight').textContent = data.stats.average + ' lbs';
        } else {
            document.getElementById('current-weight').textContent = '--';
            document.getElementById('weight-change').textContent = '--';
            document.getElementById('avg-weight').textContent = '--';
        }
        
        // Draw chart
        const ctx = document.getElementById('weightChart').getContext('2d');
        
        if (weightChart) weightChart.destroy();
        
        const labels = data.history.map(w => {
            const date = new Date(w.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        
        const weights = data.history.map(w => w.weight);
        
        weightChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Weight',
                    data: weights,
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0, 212, 255, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: '#00d4ff',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: { color: '#222' },
                        ticks: { 
                            color: '#666',
                            callback: function(value) {
                                return value + ' lbs';
                            }
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#666' }
                    }
                }
            }
        });
        
    } catch (err) {
        showToast('❌ Error loading weight data');
        console.error(err);
    }
}

// Add weight button to header
window.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('.header-actions');
    if (header) {
        const weightBtn = document.createElement('button');
        weightBtn.className = 'icon-btn';
        weightBtn.innerHTML = '⚖️';
        weightBtn.title = 'Weight Check-in';
        weightBtn.onclick = openWeightModal;
        header.insertBefore(weightBtn, header.firstChild);
    }
});
</script>
